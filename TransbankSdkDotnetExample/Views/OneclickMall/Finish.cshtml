@model string
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<nav class="breadcrumbs-container">
  <div class="breadcrumbs-items"><a href="@Url.Action("Index", "Home")" >Inicio</a>  &gt;</div>
  <div class="breadcrumbs-items"><a href="/oneclick-mall/start" >Webpay Oneclick</a> &gt; </div>
  <div class="breadcrumbs-items"><span class="current-breadcrumb">Finalizar inscripción</span></div>
</nav>

<h1>Webpay Oneclick Mall - Finalizar inscripción</h1>
<p class="mb-32">
  En esta fase, completaremos el proceso de inscripción, permitiéndonos posteriormente realizar cargos a la
  tarjeta que el Tarjetahabiente haya inscrito.
</p>

<h2 id="data">Paso 1: Datos recibidos</h2>
<p class="mb-32">
  Después de finalizar el flujo en el formulario de inscripción, recibirás un GET con la siguiente información:
</p>

<pre>
  <code class="language-text mb-32">
  @ViewBag.ResponseUrl?TBK_TOKEN=@ViewBag.Token
  </code>
</pre>

<h2 id="request">Paso 2: Petición de autorización</h2>
<p class="mb-32">
  Utiliza el token recibido para finalizar la inscripción mediante una nueva llamada a Oneclick.
</p>

<pre>
  <code class="language-csharp mb-32">
  var inscription = MallInscription.buildForIntegration(commerceCode, apiKey);
  var response = inscription.Finish(token);
  </code>
</pre>

<h2 id="response">Paso 3: Respuesta</h2>
<p class="mb-32">
  Transbank responderá con información crucial. Guarda estos detalles, ya que serán necesarios para autorizar
  transacciones futuras.
</p>

<pre><code class="language-json mb-32">@Html.Raw(ViewBag.ResponseJson)</code></pre>

<h2 id="authorize">¡La tarjeta ya está inscrita!</h2>
<p class="mb-32">Con la inscripción exitosa se pueden autorizar transacciones.</p>

<h2>Autorizar una transacción</h2>
<p class="mb-32">
  Asegúrate de guardar los datos de la respuesta obtenidos durante la inscripción. Estos serán esenciales para
  llevar a cabo transacciones de manera efectiva.
</p>

<div class="mb-32">
  <div class="tbk-table">
    <div class="table-column tbk-head">Campo</div>
    <div class="table-column tbk-head">Valor</div>
    @foreach (var item in @ViewBag.RequestData)
    {
        <div class="table-column">@item.Key</div>
        <div class="table-column">@item.Value</div>
    }
  </div>
</div>

<p class="mt-32">
  Después de una inscripción exitosa, tienes dos opciones: autorizar un pago o borrar al usuario que se
  acaba de inscribir.
</p>

<form action="@Url.Action("Authorize", "OneclickMall")" method="get">
    <input type="hidden" name="username" value="@ViewBag.Username" />
    <input type="hidden" name="tbk_user" value="@ViewBag.TbkUser" />
    <input type="hidden" name="child_commerce_code1" value="@ViewBag.ChildCommerceCode1" />
    <input type="hidden" name="child_commerce_code2" value="@ViewBag.ChildCommerceCode2" />

    <div class="tbk-card">
        <p class="mb-16">Tienda 1</p>
        <div class="card-multi-field">
            <div class="input-container">
                <label class="tbk-label" for="child_commerce_amount1">Monto:</label>
                <input type="number" name="child_commerce_amount1" class="tbk-input-text" value="10000" />
            </div>
            <div class="input-container">
                <label class="tbk-label" for="child_commerce_installments1">Cuotas:</label>
                <input type="number" name="child_commerce_installments1" class="tbk-input-text" value="0" />
            </div>
        </div>

        <p class="mb-16 mt-32">Tienda 2</p>
        <div class="card-multi-field">
            <div class="input-container">
                <label class="tbk-label" for="child_commerce_amount2">Monto:</label>
                <input type="number" name="child_commerce_amount2" class="tbk-input-text" value="5000" />
            </div>
            <div class="input-container">
                <label class="tbk-label" for="child_commerce_installments2">Cuotas:</label>
                <input type="number" name="child_commerce_installments2" class="tbk-input-text" value="0" />
            </div>
        </div>

        <div class="tbk-card-footer">
            <button class="tbk-button primary" type="submit">AUTORIZAR</button>
        </div>
    </div>
</form>

<a href="@Url.Action("Delete", "OneclickMall", new { tbk_user = ViewBag.TbkUser, username = ViewBag.Username })"
   class="tbk-button primary mt-16 mb-32">BORRAR USUARIO</a>
