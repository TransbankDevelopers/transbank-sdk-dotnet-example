@model string
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<nav class="breadcrumbs-container mb-32">
  <div class="breadcrumbs-items"><a href="@Url.Action("Index", "Home")" >Inicio</a>  &gt;</div>
  <div class="breadcrumbs-items"><a href="/oneclick-mall-diferido/start" >Webpay Oneclick Mall Diferido</a> &gt; </div>
  <div class="breadcrumbs-items"><span class="current-breadcrumb">Autorizar pago</span></div>
</nav>

<h1>Webpay Oneclick Mall Diferido - Autorizar pago</h1>
<p class="mb-32">
    En este primer paso, procederemos a autorizar una transacción en la tarjeta que ha sido previamente inscrita.
</p>

<h2 id="request">Paso 1: Petición</h2>
<p class="mb-32">
    Ahora que contamos con el "username" y el "tbkUser" obtenidos durante la inscripción, estamos listos para
    autorizar transacciones en la tarjeta inscrita.
</p>

<pre>
  <code class="language-csharp">
    List<PaymentRequest> details = new List<PaymentRequest>();
    details.Add(new PaymentRequest(
        childCommerceCode1, buyOrderMallOne, childCommerceAmount1, childCommerceInstallments1
    ));
    details.Add(new PaymentRequest(
        childCommerceCode2, buyOrderMallTwo, childCommerceAmount2, childCommerceInstallments2
    ));
    var resp = transaction.Authorize(username, tbkUser, buyOrder, details);
  </code>
</pre>

<h2 id="response">Paso 2: Respuesta</h2>
<p class="mb-32">
    Una vez que la transacción ha sido autorizada, Transbank proporcionará la siguiente información. 
    Es fundamental conservar esta respuesta y verificar que el campo <b>ResponseCode</b> tenga un valor de cero 
    y que el campo <b>Status</b> sea "AUTHORIZED".
</p>

<pre><code class="language-json mb-32">@Html.Raw(ViewBag.ResponseJson)</code></pre>

<h2>¡Casi listo!</h2>
<p class="mb-32">
    Ya puedes mostrar al usuario una página de éxito de la transacción. 
    Debes tener en cuenta que la transacción aún no ha sido capturada, solo se ha retenido el saldo en la tarjeta del Tarjetahabiente.
</p>

@foreach (var detail in ViewBag.ResponseData.Details)
{
    <form asp-action="Capture" asp-controller="OneclickMallDeferred" method="get">
        <input type="hidden" name="buy_order" value="@ViewBag.ResponseData.BuyOrder" />

        <div class="tbk-card">
            <div class="card-multi-field">
                <div class="input-container">
                    <label class="tbk-label" for="child_commerce_code">Código de comercio (tienda hija):</label>
                    <input class="tbk-input-text" type="text" name="child_commerce_code" value="@detail.CommerceCode" />
                </div>
                <div class="input-container">
                    <label class="tbk-label" for="child_buy_order">Orden de compra (tienda hija):</label>
                    <input class="tbk-input-text" type="text" name="child_buy_order" value="@detail.BuyOrder" />
                </div>
                <div class="input-container">
                    <label class="tbk-label" for="authorization_code">Código de autorización (tienda hija):</label>
                    <input class="tbk-input-text" type="text" name="authorization_code" value="@detail.AuthorizationCode" />
                </div>
                <div class="input-container">
                    <label class="tbk-label" for="amount">Monto a capturar (tienda hija):</label>
                    <input class="tbk-input-text" type="text" name="amount" value="@detail.Amount" />
                </div>
            </div>
            <div class="tbk-card-footer">
                <button type="submit" class="tbk-button primary">CAPTURAR</button>
            </div>
        </div>
    </form>
}

<a class="tbk-button primary mb-32"
   href="@Url.Action("Status", "OneclickMallDeferred", new { buy_order = ViewBag.ResponseData.BuyOrder })">
   CONSULTAR ESTADO
</a>
